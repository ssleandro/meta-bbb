From 0a7a55fdb670976f141076053eaf4306f250db1c Mon Sep 17 00:00:00 2001
From: Fabio Berton <fabio.berton@ossystems.com.br>
Date: Tue, 10 Apr 2018 09:14:48 -0300
Subject: [PATCH 5/5] Add UpdateHub support for SMAAI5
Organization: O.S. Systems Software LTDA.

Signed-off-by: Fabio Berton <fabio.berton@ossystems.com.br>
---
 configs/am335x_evm_defconfig           |  10 +--
 configs/am335x_evm_installer_defconfig |  46 ++++++++++
 include/configs/am335x_evm.h           | 117 ++++++++++++++++++++++---
 scripts/config_whitelist.txt           |   1 +
 4 files changed, 158 insertions(+), 16 deletions(-)
 create mode 100644 configs/am335x_evm_installer_defconfig

diff --git a/configs/am335x_evm_defconfig b/configs/am335x_evm_defconfig
index 873090a7ad9..d58e56ad399 100644
--- a/configs/am335x_evm_defconfig
+++ b/configs/am335x_evm_defconfig
@@ -4,9 +4,8 @@ CONFIG_TI_COMMON_CMD_OPTIONS=y
 CONFIG_AM33XX=y
 # CONFIG_SPL_NAND_SUPPORT is not set
 CONFIG_DISTRO_DEFAULTS=y
+CONFIG_SYS_EXTRA_OPTIONS="EMMC_BOOT"
 CONFIG_BOOTCOMMAND="if test ${boot_fit} -eq 1; then run update_to_fit; fi; run findfdt; run init_console; run envboot; run distro_bootcmd"
-# CONFIG_ENV_IS_IN_FAT is not set
-CONFIG_ENV_IS_NOWHERE=y
 CONFIG_SYS_CONSOLE_INFO_QUIET=y
 CONFIG_VERSION_VARIABLE=y
 CONFIG_ARCH_MISC_INIT=y
@@ -21,6 +20,8 @@ CONFIG_FASTBOOT=y
 CONFIG_CMD_SPL=y
 # CONFIG_CMD_FLASH is not set
 # CONFIG_CMD_SETEXPR is not set
+CONFIG_CMD_BTRFS=y
+CONFIG_ENV_IS_IN_MMC=y
 CONFIG_DFU_TFTP=y
 CONFIG_DFU_MMC=y
 CONFIG_DFU_RAM=y
@@ -28,6 +29,7 @@ CONFIG_MMC_OMAP_HS=y
 CONFIG_SPI_FLASH=y
 CONFIG_SPI_FLASH_WINBOND=y
 CONFIG_PHYLIB=y
+CONFIG_PHY_MSCC=y
 CONFIG_SYS_NS16550=y
 CONFIG_OMAP3_SPI=y
 CONFIG_USB=y
@@ -40,9 +42,5 @@ CONFIG_USB_GADGET_VENDOR_NUM=0x0451
 CONFIG_USB_GADGET_PRODUCT_NUM=0xd022
 CONFIG_USB_ETHER=y
 CONFIG_USBNET_HOST_ADDR="de:ad:be:af:00:00"
-CONFIG_FS_BTRFS=y
-CONFIG_CMD_BTRFS=y
-CONFIG_LZO=y
 CONFIG_OF_LIBFDT=y
 CONFIG_OF_LIBFDT_OVERLAY=y
-CONFIG_PHY_MSCC=y
diff --git a/configs/am335x_evm_installer_defconfig b/configs/am335x_evm_installer_defconfig
new file mode 100644
index 00000000000..f554c7c3413
--- /dev/null
+++ b/configs/am335x_evm_installer_defconfig
@@ -0,0 +1,46 @@
+CONFIG_ARM=y
+CONFIG_ARCH_OMAP2PLUS=y
+CONFIG_TI_COMMON_CMD_OPTIONS=y
+CONFIG_AM33XX=y
+# CONFIG_SPL_NAND_SUPPORT is not set
+CONFIG_DISTRO_DEFAULTS=y
+CONFIG_SYS_EXTRA_OPTIONS="INSTALLER_ENV"
+CONFIG_BOOTCOMMAND="if test ${boot_fit} -eq 1; then run update_to_fit; fi; run findfdt; run init_console; run envboot; run distro_bootcmd"
+CONFIG_SYS_CONSOLE_INFO_QUIET=y
+CONFIG_VERSION_VARIABLE=y
+CONFIG_ARCH_MISC_INIT=y
+CONFIG_SPL=y
+CONFIG_SPL_MUSB_NEW_SUPPORT=y
+CONFIG_SPL_OS_BOOT=y
+CONFIG_AUTOBOOT_KEYED=y
+CONFIG_AUTOBOOT_PROMPT="Press SPACE to abort autoboot in %d seconds\n"
+CONFIG_AUTOBOOT_DELAY_STR="d"
+CONFIG_AUTOBOOT_STOP_STR=" "
+CONFIG_FASTBOOT=y
+CONFIG_CMD_SPL=y
+# CONFIG_CMD_FLASH is not set
+# CONFIG_CMD_SETEXPR is not set
+CONFIG_CMD_BTRFS=y
+CONFIG_ENV_IS_NOWHERE=y
+CONFIG_DFU_TFTP=y
+CONFIG_DFU_MMC=y
+CONFIG_DFU_RAM=y
+CONFIG_MMC_OMAP_HS=y
+CONFIG_SPI_FLASH=y
+CONFIG_SPI_FLASH_WINBOND=y
+CONFIG_PHYLIB=y
+CONFIG_PHY_MSCC=y
+CONFIG_SYS_NS16550=y
+CONFIG_OMAP3_SPI=y
+CONFIG_USB=y
+CONFIG_USB_MUSB_HOST=y
+CONFIG_USB_MUSB_GADGET=y
+CONFIG_USB_STORAGE=y
+CONFIG_USB_GADGET=y
+CONFIG_USB_GADGET_MANUFACTURER="Texas Instruments"
+CONFIG_USB_GADGET_VENDOR_NUM=0x0451
+CONFIG_USB_GADGET_PRODUCT_NUM=0xd022
+CONFIG_USB_ETHER=y
+CONFIG_USBNET_HOST_ADDR="de:ad:be:af:00:00"
+CONFIG_OF_LIBFDT=y
+CONFIG_OF_LIBFDT_OVERLAY=y
diff --git a/include/configs/am335x_evm.h b/include/configs/am335x_evm.h
index 078a706676e..5ed01116b16 100644
--- a/include/configs/am335x_evm.h
+++ b/include/configs/am335x_evm.h
@@ -33,8 +33,8 @@
 /* Custom script for NOR */
 #define CONFIG_SYS_LDSCRIPT		"board/ti/am335x/u-boot.lds"

-/* Always 128 KiB env size */
-#define CONFIG_ENV_SIZE			(128 << 10)
+/* Always 64 KiB env size */
+#define CONFIG_ENV_SIZE			(64 << 10)

 #ifdef CONFIG_NAND
 #define NANDARGS \
@@ -231,6 +231,109 @@
 	BOOTENV
 #endif

+#undef CONFIG_EXTRA_ENV_SETTINGS
+#undef CONFIG_BOOTCOMMAND
+#if defined(CONFIG_INSTALLER_ENV)
+#define CONFIG_EXTRA_ENV_SETTINGS \
+    DEFAULT_LINUX_BOOT_ENV \
+    "console=ttyS0,115200n8\0" \
+    "fdtfile=am335x-boneblack-uboot.dtb\0" \
+    "fdt_buffer=0x60000\0" \
+    "load_image=load mmc 0:1 ${loadaddr} /boot/zImage\0"  \
+    "load_fdt=" \
+        "load mmc 0:1 ${fdtaddr} /boot/${fdtfile}; " \
+        "load mmc 0:1 ${rdaddr} /lib/firmware/univ-bbb-Exx-00A0.dtbo; " \
+        "fdt addr ${fdtaddr}; " \
+        "fdt resize ${fdt_buffer};" \
+        "fdt apply ${rdaddr}; "  \
+        "fdt resize ${fdt_buffer}; " \
+        "load mmc 0:1 ${rdaddr} /lib/firmware/BB-BONE-eMMC1-01-00A0.dtbo; " \
+        "fdt addr ${fdtaddr}; " \
+        "fdt resize ${fdt_buffer}; " \
+        "fdt apply ${rdaddr}; " \
+        "fdt resize ${fdt_buffer}\0" \
+    "mmc_args=setenv bootargs console=${console} root=/dev/mmcblk0p1 rootfstype=ext4\0" \
+    "bootcmd=echo SMAAI5 Installer v2; run load_image; run load_fdt; run mmc_args; " \
+    "bootz ${loadaddr} - ${fdtaddr}\0"
+#else
+/*
+ * UpdateHub configuration
+ */
+#define CONFIG_BOOTCOUNT_ENV
+/* Environment */
+#define UPDATEHUB_LOAD_OS_A     "run runbootenv; load mmc 1:1 ${loadaddr} /boot/${bootfile}; " \
+                                "load mmc 1:1 ${fdtaddr} /boot/${fdtfile}; " \
+                                \
+                                "load mmc 1:1 ${rdaddr} /lib/firmware/univ-bbb-Exx-00A0.dtbo; " \
+                                "fdt addr ${fdtaddr}; fdt resize ${fdt_buffer}; " \
+                                "fdt apply ${rdaddr}; fdt resize ${fdt_buffer}; " \
+                                \
+                                "load mmc 1:1 ${rdaddr} /lib/firmware/ADAFRUIT-SPI0-00A0.dtbo; " \
+                                "fdt addr ${fdtaddr}; fdt resize ${fdt_buffer}; " \
+                                "fdt apply ${rdaddr}; fdt resize ${fdt_buffer}; " \
+                                \
+                                "load mmc 1:1 ${rdaddr} /lib/firmware/BB-BONE-eMMC1-01-00A0.dtbo; " \
+                                "fdt addr ${fdtaddr}; fdt resize ${fdt_buffer}; " \
+                                "fdt apply ${rdaddr}; fdt resize ${fdt_buffer}; " \
+                                \
+                                "load mmc 1:1 ${rdaddr} /lib/firmware/BB-ADC-00A0.dtbo; " \
+                                "fdt addr ${fdtaddr}; fdt resize ${fdt_buffer}; " \
+                                "fdt apply ${rdaddr}; fdt resize ${fdt_buffer}; " \
+                                \
+                                "load mmc 1:1 ${rdaddr} /lib/firmware/BB-UART1-00A0.dtbo; " \
+                                "fdt addr ${fdtaddr}; fdt resize ${fdt_buffer}; " \
+                                "fdt apply ${rdaddr}; fdt resize ${fdt_buffer}; " \
+                                \
+                                "load mmc 1:1 ${rdaddr} /lib/firmware/BB-UART4-00A0.dtbo; " \
+                                "fdt addr ${fdtaddr}; fdt resize ${fdt_buffer}; " \
+                                "fdt apply ${rdaddr}; fdt resize ${fdt_buffer}; "
+#define UPDATEHUB_FIND_ROOT_A   "part uuid mmc 1:1 uuid"
+
+#define UPDATEHUB_LOAD_OS_B     "run runbootenv; load mmc 1:2 ${loadaddr} /boot/${bootfile}; " \
+                                "load mmc 1:2 ${fdtaddr} /boot/${fdtfile}; " \
+                                \
+                                "load mmc 1:2 ${rdaddr} /lib/firmware/univ-bbb-Exx-00A0.dtbo; " \
+                                "fdt addr ${fdtaddr}; fdt resize ${fdt_buffer}; " \
+                                "fdt apply ${rdaddr}; fdt resize ${fdt_buffer}; " \
+                                \
+                                "load mmc 1:2 ${rdaddr} /lib/firmware/ADAFRUIT-SPI0-00A0.dtbo; " \
+                                "fdt addr ${fdtaddr}; fdt resize ${fdt_buffer}; " \
+                                "fdt apply ${rdaddr}; fdt resize ${fdt_buffer}; " \
+                                \
+                                "load mmc 1:2 ${rdaddr} /lib/firmware/BB-BONE-eMMC1-01-00A0.dtbo; " \
+                                "fdt addr ${fdtaddr}; fdt resize ${fdt_buffer}; " \
+                                "fdt apply ${rdaddr}; fdt resize ${fdt_buffer}; " \
+                                \
+                                "load mmc 1:2 ${rdaddr} /lib/firmware/BB-ADC-00A0.dtbo; " \
+                                "fdt addr ${fdtaddr}; fdt resize ${fdt_buffer}; " \
+                                "fdt apply ${rdaddr}; fdt resize ${fdt_buffer}; " \
+                                \
+                                "load mmc 1:2 ${rdaddr} /lib/firmware/BB-UART1-00A0.dtbo; " \
+                                "fdt addr ${fdtaddr}; fdt resize ${fdt_buffer}; " \
+                                "fdt apply ${rdaddr}; fdt resize ${fdt_buffer}; " \
+                                \
+                                "load mmc 1:2 ${rdaddr} /lib/firmware/BB-UART4-00A0.dtbo; " \
+                                "fdt addr ${fdtaddr}; fdt resize ${fdt_buffer}; " \
+                                "fdt apply ${rdaddr}; fdt resize ${fdt_buffer}; "
+#define UPDATEHUB_FIND_ROOT_B   "part uuid mmc 1:2 uuid"
+
+#define UPDATEHUB_BOOTARGS      "console=${console} root=PARTUUID=${uuid} bone_capemgr.uboot_capemgr_enabled=1 " \
+                                "coherent_pool=1M net.ifnames=0 rootfstype=ext4 rootwait rw quiet"
+#define UPDATEHUB_BOOTCMD       "bootz ${loadaddr} - ${fdtaddr}"
+
+#include <configs/updatehub-common.h>
+
+#define CONFIG_EXTRA_ENV_SETTINGS               \
+    DEFAULT_LINUX_BOOT_ENV \
+    "bootfile=zImage\0" \
+    "fdtfile=am335x-boneblack-uboot.dtb\0" \
+    "console=ttyS0,115200n8\0" \
+    "fdt_buffer=0x60000\0" \
+    "runbootenv=if load mmc 0:1 ${loadaddr} boot/uEnv.txt; " \
+    "then env import -t $loadaddr $filesize; run bootcmd ; fi\0" \
+    UPDATEHUB_ENV
+#endif
+
 /* NS16550 Configuration */
 #define CONFIG_SYS_NS16550_COM1		0x44e09000	/* Base EVM has UART0 */
 #define CONFIG_SYS_NS16550_COM2		0x48022000	/* UART1 */
@@ -249,10 +352,6 @@

 /* SPL */
 #ifndef CONFIG_NOR_BOOT
-/* Bootcount using the RTC block */
-#define CONFIG_BOOTCOUNT_LIMIT
-#define CONFIG_BOOTCOUNT_AM33XX
-#define CONFIG_SYS_BOOTCOUNT_BE

 /* USB gadget RNDIS */
 #endif
@@ -360,10 +459,8 @@
 #define CONFIG_ENV_OFFSET_REDUND	(896 << 10) /* 896 KiB in */
 #elif defined(CONFIG_EMMC_BOOT)
 #define CONFIG_SYS_MMC_ENV_DEV		1
-#define CONFIG_SYS_MMC_ENV_PART		2
-#define CONFIG_ENV_OFFSET		0x0
-#define CONFIG_ENV_OFFSET_REDUND	(CONFIG_ENV_OFFSET + CONFIG_ENV_SIZE)
-#define CONFIG_SYS_REDUNDAND_ENVIRONMENT
+#define CONFIG_ENV_SECT_SIZE		(4 * 1024) /* 4 KB sectors */
+#define CONFIG_ENV_OFFSET		    (4 * 1024) /* 4 KiB in */
 #define CONFIG_SYS_MMC_MAX_DEVICE	2
 #elif defined(CONFIG_SD_BOOT)
 #define CONFIG_ENV_IS_IN_FAT
diff --git a/scripts/config_whitelist.txt b/scripts/config_whitelist.txt
index a27dc4fc382..9a279c7d415 100644
--- a/scripts/config_whitelist.txt
+++ b/scripts/config_whitelist.txt
@@ -1056,6 +1056,7 @@ CONFIG_INI_CASE_INSENSITIVE
 CONFIG_INI_MAX_LINE
 CONFIG_INI_MAX_NAME
 CONFIG_INI_MAX_SECTION
+CONFIG_INSTALLER_ENV
 CONFIG_INTEGRITY
 CONFIG_INTERRUPTS
 CONFIG_IO
--
2.22.0
